---
AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Mission Life New User Email Invitation
Resources:

# Lambda Resources
  MissionLifeNewUsersSchedulerLambda:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../dist/mission-life-new-users-scheduler.zip
      FunctionName: missionLifeNewUsersScheduler
      Handler: index.handler
      MemorySize: 256
      Role: !GetAtt MissionLifeNewUsersSchedulerLambdaExecutionRole.Arn
      Runtime: nodejs12.x
      Timeout: 30
      Environment:
        Variables:
          TEST_ENV: {{{TEST_ENV}}}

  MissionLifeNewUsersSchedulerLambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          Effect: Allow
          Principal:
            Service: lambda.amazonaws.com
          Action: sts:AssumeRole
      Path: '/'
      Policies:
      - PolicyName: logs
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
            Resource: arn:aws:logs:*:*:*

  MissionLifeNewUsersSchedulerLambdaLogGroup:
    DependsOn: MissionLifeNewUsersSchedulerLambda
    Type: AWS::Logs::LogGroup
    Properties:
      RetentionInDays: 14
      LogGroupName: !Join
        - ''
        - - 'aws/lambda/'
          - !Ref MissionLifeNewUsersSchedulerLambda

# - PolicyName: dynamodb
#   PolicyDocument:
#     Statement:
#     - Effect: Allow
#       Action:
#       - dynamodb:GetItem
#       - dynamodb:GetRecords
#       - dynamodb:BatchGetItem
#       - dynamodb:DescribeTable
#       - dynamodb:Query
#       - dynamodb:Scan
#       - dynamodb:PutItem
#       Resource:
#       - !GetAtt CoverageReportsTable.Arn
# New User Scheduler Dynamo Resources
# WebAppUsersTable:
#   Type: AWS::DynamoDB::Table
#   Properties:
#     TableName: "WEB_APP_USERS"
#     AttributeDefinitions:
#       -
#         AttributeName: "SEARCH_ID"
#         AttributeType: "S"
#       -
#         AttributeName: "END_DATE"
#         AttributeType: "S"
#     KeySchema:
#       -
#         AttributeName: "SEARCH_ID"
#         KeyType: "HASH"
#     GlobalSecondaryIndexes:
#       -
#         IndexName: "END_DATE_GSI"
#         KeySchema:
#           -
#           AttributeName: "END_DATE"
#           KeyType: "HASH"
#         Projection:
#           ProjectionType: "ALL"
#     BillingMode: "PAY_PER_REQUEST"
# New User Scheduler Cloudwatch & Alarm Resources	
# MissionLifeNewUsersSchedulerRule:
#   Type: AWS::Events::Rule
#   Properties:
#     ScheduleExpression: "cron(00 13 * * ? *)"
#     Targets:
#     - Id: MissionLifeNewUsersSchedulerRuleTarget
#     Arn: !GetAtt MissionLifeNewUsersSchedulerLambda.Arn
# MissionLifeNewUsersSchedulerInvokePermission:
#   Type: AWS::Lambda::Permission
#   Properties:
#     FunctionName: !GetAtt MissionLifeNewUsersSchedulerLambda.Arn
#     Action: "lambda:InvokeFunction"
#     Principal: "events.amazonaws.com"
#     SourceArn: !GetAtt MissionLifeNewUsersSchedulerRule.Arn